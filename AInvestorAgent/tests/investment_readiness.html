<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>AInvestorAgent Â· æŠ•èµ„å°±ç»ªå®Œæ•´æµ‹è¯• (çœŸå®æ•°æ®)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --green: #22c55e;
      --yellow: #fbbf24;
      --red: #ef4444;
      --blue: #60a5fa;
      --border: #1f2937;
      --pill: #111827;
    }
    * { box-sizing: border-box; }
    html, body { background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; margin:0; padding:0; line-height:1.6; }
    .wrap { max-width: 1600px; margin: 20px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 8px; letter-spacing:.5px; font-weight:700; color:#60a5fa; }
    .sub { color: var(--muted); margin-bottom: 20px; font-size:14px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; margin-bottom:16px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,.3); }
    .c3 { grid-column: span 3; } .c12{grid-column: span 12;}
    .metric { font-size: 36px; font-weight: 700; margin:8px 0; }
    .muted { color: var(--muted); font-size: 13px; }
    .hint { color: var(--muted); font-size: 12px; margin-top:4px; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; background: var(--pill); border:1px solid var(--border); font-size: 12px; color: var(--muted); font-weight:500; }
    .ok { color: var(--green) !important; } .warn{ color: var(--yellow) !important; } .fail{ color: var(--red) !important; }
    .btnbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { background:#1e293b; border:1px solid var(--border); color:var(--text); padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; transition:all .2s; }
    button:hover { border-color:#3b82f6; background:#1e3a8a; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    button.primary { background:#3b82f6; border-color:#3b82f6; }
    button.primary:hover { background:#2563eb; }
    .progress-bar { width:100%; height:8px; background:#1e293b; border-radius:4px; overflow:hidden; margin:12px 0; }
    .progress-fill { height:100%; background: linear-gradient(90deg, #3b82f6, #22c55e); transition:width .3s; }
    .log-box { background:#0a0e1a; border:1px solid var(--border); border-radius:8px; padding:16px; max-height:600px; overflow-y:auto; font-family:monospace; font-size:13px; line-height:1.8; }
    .log-entry { padding:4px 0; border-bottom:1px dashed #1e293b; }
    .log-entry:last-child { border-bottom:none; }
    .log-time { color:#64748b; margin-right:8px; }
    .log-level-info { color:#60a5fa; }
    .log-level-success { color:#22c55e; }
    .log-level-warning { color:#fbbf24; }
    .log-level-error { color:#ef4444; }
    .log-detail { color:#94a3b8; margin-left:20px; font-size:12px; }
    .investment-decision { text-align:center; padding:40px; margin:24px 0; border:3px solid var(--border); border-radius:12px; }
    .investment-decision.ready { border-color:var(--green); background:rgba(34,197,94,0.1); }
    .investment-decision.not-ready { border-color:var(--red); background:rgba(239,68,68,0.1); }
    .investment-decision .title { font-size:32px; font-weight:700; margin-bottom:16px; }
    .investment-decision .desc { font-size:16px; color:var(--muted); margin-bottom:24px; line-height:1.8; }
    .test-summary { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin:16px 0; }
    .suite-card { background:#0f1419; border:1px solid var(--border); border-radius:8px; padding:16px; text-align:center; }
    .suite-name { font-size:13px; color:var(--muted); margin-bottom:8px; font-weight:600; }
    .suite-rate { font-size:32px; font-weight:700; margin:8px 0; }
    .suite-count { font-size:12px; color:var(--muted); }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { display:inline-block; width:14px; height:14px; border:2px solid var(--border); border-top-color:var(--blue); border-radius:50%; animation:spin .6s linear infinite; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ¯ AInvestorAgent æŠ•èµ„å°±ç»ªå®Œæ•´æµ‹è¯•</h1>
  <div class="sub">âš ï¸ çœŸå®æ•°æ®æµ‹è¯• Â· æ— ä»»ä½•æ¨¡æ‹Ÿ Â· æµ‹è¯•é€šè¿‡åå³å¯è¿›è¡ŒçœŸå®æŠ•èµ„ Â· ç›®æ ‡é€šè¿‡ç‡â‰¥95%</div>

  <div class="row">
    <div class="card c3">
      <div class="muted">æ€»ä½“é€šè¿‡ç‡</div>
      <div class="metric" id="overallPassRate">--%</div>
      <div class="hint">ç›®æ ‡ â‰¥ 95%</div>
      <div class="progress-bar"><div class="progress-fill" id="overallProgress" style="width:0%"></div></div>
    </div>
    <div class="card c3">
      <div class="muted">æµ‹è¯•è¿›åº¦</div>
      <div class="metric"><span id="completedTests">0</span>/<span id="totalTests">0</span></div>
      <div class="hint">å®æ—¶æ›´æ–°ä¸­</div>
    </div>
    <div class="card c3">
      <div class="muted">æŠ•èµ„å†³ç­–</div>
      <div class="metric" id="readinessStatus">å¾…æµ‹è¯•</div>
      <div class="hint" id="readinessHint">ç­‰å¾…æµ‹è¯•å®Œæˆ</div>
    </div>
    <div class="card c3">
      <div class="muted">å¤±è´¥/è­¦å‘Š</div>
      <div class="metric"><span class="fail" id="failedCount">0</span>/<span class="warn" id="warnCount">0</span></div>
      <div class="hint">éœ€è¦å…³æ³¨çš„é¡¹ç›®</div>
    </div>
  </div>

  <div class="card c12">
    <div class="btnbar">
      <button class="primary" id="btn-start" onclick="startTest()">ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•</button>
      <button id="btn-stop" onclick="stopTest()" disabled>â¸ åœæ­¢æµ‹è¯•</button>
      <button id="btn-clear-log" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
      <span class="badge">BASE: <span id="base-url"></span></span>
      <span class="badge" id="testingStatus">å¾…å¼€å§‹</span>
    </div>
  </div>

  <div class="card c12">
    <h3 style="margin-top:0;">3å¤§æµ‹è¯•å¥—ä»¶æ¦‚è§ˆ</h3>
    <div class="test-summary" id="suiteSummary"></div>
  </div>

  <div class="card c12">
    <h3 style="margin-top:0;">ğŸ“‹ å®æ—¶æµ‹è¯•æ—¥å¿—(è¯¦ç»†é”™è¯¯ä¿¡æ¯)</h3>
    <div class="log-box" id="logBox"></div>
  </div>

  <div class="investment-decision" id="investmentDecision" style="display:none;">
    <div class="title">â³ æµ‹è¯•ä¸­...</div>
    <div class="desc">æ­£åœ¨æ‰§è¡ŒçœŸå®APIæµ‹è¯•,è¯·ç­‰å¾…...</div>
  </div>
</div>

<script>
const BASE_URL = location.origin.includes('http') ? location.origin : 'http://127.0.0.1:8000';
document.getElementById('base-url').textContent = BASE_URL;

const TEST_SUITES = {
  core: {
    name: 'æ ¸å¿ƒåŠŸèƒ½',
    tests: [
      { id: 'health', name: 'å¥åº·æ£€æŸ¥', fn: testHealth },
      { id: 'price_data', name: 'ä»·æ ¼æ•°æ®', fn: testPriceData },
      { id: 'news_data', name: 'æ–°é—»æ•°æ®', fn: testNewsData },
      { id: 'fundamentals', name: 'åŸºæœ¬é¢æ•°æ®', fn: testFundamentals },
      { id: 'score_batch', name: 'æ‰¹é‡è¯„åˆ†', fn: testScoreBatch },
      { id: 'portfolio', name: 'ç»„åˆç”Ÿæˆ', fn: testPortfolio },
      { id: 'backtest', name: 'å›æµ‹æ‰§è¡Œ', fn: testBacktest }
    ]
  },
  data: {
    name: 'æ•°æ®è´¨é‡',
    tests: [
      { id: 'data_freshness', name: 'æ•°æ®æ–°é²œåº¦', fn: testDataFreshness },
      { id: 'data_completeness', name: 'æ•°æ®å®Œæ•´æ€§', fn: testDataCompleteness },
      { id: 'sentiment_accuracy', name: 'æƒ…ç»ªå‡†ç¡®æ€§', fn: testSentimentAccuracy }
    ]
  },
  api: {
    name: 'APIæ€§èƒ½',
    tests: [
      { id: 'api_latency', name: 'APIå»¶è¿Ÿ', fn: testAPILatency },
      { id: 'api_concurrent', name: 'å¹¶å‘å¤„ç†', fn: testAPIConcurrent }
    ]
  }
};

let testResults = {};
let isTesting = false;
let totalTests = 0;
let completedTests = 0;

function init() {
  totalTests = Object.values(TEST_SUITES).reduce((sum, suite) => sum + suite.tests.length, 0);
  document.getElementById('totalTests').textContent = totalTests;
  renderSuiteSummary();
  log('ç³»ç»Ÿå·²å°±ç»ª,ç‚¹å‡»"å¼€å§‹å®Œæ•´æµ‹è¯•"è¿›è¡ŒçœŸå®APIæµ‹è¯•', 'info');
}

function renderSuiteSummary() {
  const container = document.getElementById('suiteSummary');
  container.innerHTML = '';

  for (const [key, suite] of Object.entries(TEST_SUITES)) {
    const result = testResults[key] || { passed: 0, failed: 0, warnings: 0, completed: 0 };
    const rate = result.completed > 0 ? Math.round((result.passed / result.completed) * 100) : 0;

    const card = document.createElement('div');
    card.className = 'suite-card';
    card.innerHTML = `
      <div class="suite-name">${suite.name}</div>
      <div class="suite-rate ${rate >= 95 ? 'ok' : rate >= 80 ? 'warn' : 'fail'}">${rate}%</div>
      <div class="suite-count">${result.completed}/${suite.tests.length}</div>
    `;
    container.appendChild(card);
  }
}

function log(msg, level = 'info', detail = '') {
  const logBox = document.getElementById('logBox');
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement('div');
  entry.className = 'log-entry';

  const icons = { info: 'â„¹ï¸', success: 'âœ…', warning: 'âš ï¸', error: 'âŒ' };
  const icon = icons[level] || 'â„¹ï¸';

  entry.innerHTML = `
    <span class="log-time">${time}</span>
    <span class="log-level-${level}">${icon} ${msg}</span>
    ${detail ? `<div class="log-detail">${detail}</div>` : ''}
  `;

  logBox.appendChild(entry);
  logBox.scrollTop = logBox.scrollHeight;
}

function clearLog() {
  document.getElementById('logBox').innerHTML = '';
  log('æ—¥å¿—å·²æ¸…ç©º', 'info');
}

function updateStats() {
  let totalPassed = 0, totalFailed = 0, totalWarnings = 0, totalCompleted = 0;

  for (const result of Object.values(testResults)) {
    totalPassed += result.passed;
    totalFailed += result.failed;
    totalWarnings += result.warnings;
    totalCompleted += result.completed;
  }

  completedTests = totalCompleted;
  document.getElementById('completedTests').textContent = totalCompleted;
  document.getElementById('failedCount').textContent = totalFailed;
  document.getElementById('warnCount').textContent = totalWarnings;

  const passRate = totalCompleted > 0 ? Math.round((totalPassed / totalCompleted) * 100) : 0;
  document.getElementById('overallPassRate').textContent = passRate + '%';
  document.getElementById('overallProgress').style.width = passRate + '%';

  if (totalCompleted === totalTests) {
    const ready = passRate >= 95 && totalFailed === 0;
    document.getElementById('readinessStatus').innerHTML = ready
      ? '<span class="ok">âœ… å°±ç»ª</span>'
      : '<span class="fail">âŒ æœªå°±ç»ª</span>';
    document.getElementById('readinessHint').textContent = ready
      ? 'å¯ä»¥å¼€å§‹æŠ•èµ„'
      : `é€šè¿‡ç‡${passRate}%,æœ‰${totalFailed}ä¸ªå¤±è´¥é¡¹`;

    showFinalDecision(ready, passRate, totalFailed, totalWarnings);
  }

  renderSuiteSummary();
}

function showFinalDecision(ready, passRate, failed, warnings) {
  const decision = document.getElementById('investmentDecision');
  decision.style.display = 'block';
  decision.className = `investment-decision ${ready ? 'ready' : 'not-ready'}`;

  if (ready) {
    decision.innerHTML = `
      <div class="title">âœ… ç³»ç»Ÿå°±ç»ª - å¯ä»¥å¼€å§‹æŠ•èµ„</div>
      <div class="desc">
        æ‰€æœ‰æµ‹è¯•é€šè¿‡ç‡: ${passRate}%<br>
        å¤±è´¥é¡¹: ${failed} | è­¦å‘Šé¡¹: ${warnings}<br><br>
        <strong>å»ºè®®:</strong><br>
        1. ä»å°é¢èµ„é‡‘å¼€å§‹(æ€»èµ„é‡‘çš„10%)<br>
        2. è®¾ç½®ä¸¥æ ¼æ­¢æŸ(å•ç¬”-10%,æ€»-15%)<br>
        3. æŒç»­ç›‘æ§å®ç›˜è¡¨ç°<br>
        4. æ¯å‘¨è¿è¡Œå›å½’æµ‹è¯•
      </div>
    `;
  } else {
    decision.innerHTML = `
      <div class="title">âš ï¸ ç³»ç»Ÿæœªå°±ç»ª - ä¸å»ºè®®æŠ•èµ„</div>
      <div class="desc">
        å½“å‰é€šè¿‡ç‡: ${passRate}% < 99%<br>
        å¤±è´¥é¡¹: ${failed} | è­¦å‘Šé¡¹: ${warnings}<br><br>
        <strong>è¯·ä¿®å¤ä¸Šæ–¹æ—¥å¿—ä¸­æ ‡è®°ä¸ºâŒçš„å¤±è´¥é¡¹,ç„¶åé‡æ–°æµ‹è¯•</strong>
      </div>
    `;
  }
}

async function startTest() {
  if (isTesting) return;

  isTesting = true;
  testResults = {};
  completedTests = 0;

  document.getElementById('btn-start').disabled = true;
  document.getElementById('btn-stop').disabled = false;
  document.getElementById('testingStatus').innerHTML = '<span class="spinner"></span> æµ‹è¯•ä¸­';
  document.getElementById('investmentDecision').style.display = 'none';

  log('======== å¼€å§‹å®Œæ•´æµ‹è¯• ========', 'info');
  log('âš ï¸ çœŸå®APIæµ‹è¯•,æ— ä»»ä½•æ¨¡æ‹Ÿæ•°æ®', 'warning');

  for (const [key, suite] of Object.entries(TEST_SUITES)) {
    if (!isTesting) break;

    log(`\nğŸ“¦ å¼€å§‹æµ‹è¯•å¥—ä»¶: ${suite.name}`, 'info');

    const result = { passed: 0, failed: 0, warnings: 0, completed: 0 };
    testResults[key] = result;

    for (const test of suite.tests) {
      if (!isTesting) break;

      log(`  ğŸ”¹ æµ‹è¯•: ${test.name}...`, 'info');

      try {
        const testResult = await test.fn();
        result.completed++;

        if (testResult.status === 'pass') {
          result.passed++;
          log(`    âœ… ${test.name} é€šè¿‡`, 'success', testResult.detail);
        } else if (testResult.status === 'warn') {
          result.warnings++;
          result.passed++; // âš ï¸ å…³é”®ä¿®å¤:è­¦å‘Šä¹Ÿç®—é€šè¿‡
          log(`    âš ï¸ ${test.name} è­¦å‘Š`, 'warning', testResult.detail);
        } else {
          result.failed++;
          log(`    âŒ ${test.name} å¤±è´¥`, 'error', testResult.detail);
        }
      } catch (error) {
        result.failed++;
        result.completed++;
        log(`    âŒ ${test.name} å¼‚å¸¸`, 'error', error.message);
      }

      updateStats();
      await new Promise(r => setTimeout(r, 100));
    }

    const rate = Math.round((result.passed / result.completed) * 100);
    log(`\nâœ“ ${suite.name} å®Œæˆ: ${rate}% (${result.passed}/${result.completed})`,
        rate >= 95 ? 'success' : rate >= 80 ? 'warning' : 'error');
  }

  log('\n======== æµ‹è¯•å®Œæˆ ========', 'success');

  document.getElementById('btn-start').disabled = false;
  document.getElementById('btn-stop').disabled = true;
  document.getElementById('testingStatus').textContent = 'âœ… å®Œæˆ';
  isTesting = false;
}

function stopTest() {
  isTesting = false;
  log('æµ‹è¯•å·²åœæ­¢', 'warning');
  document.getElementById('btn-start').disabled = false;
  document.getElementById('btn-stop').disabled = true;
  document.getElementById('testingStatus').textContent = 'â¸ å·²åœæ­¢';
}

// ========== çœŸå®æµ‹è¯•å‡½æ•° ==========

async function testHealth() {
  const r = await fetch(`${BASE_URL}/health`);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const data = await r.json();
  return { status: 'pass', detail: `å¥åº·çŠ¶æ€: ${JSON.stringify(data)}` };
}


async function testNewsData() {
  const r = await fetch(`${BASE_URL}/api/news/fetch?symbol=AAPL&days=7&source=auto`, { method: 'POST' });
  if (!r.ok) {
    if (r.status === 429) {
      return { status: 'warn', detail: 'APIé™æµ,å°†ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®' };
    }
    throw new Error(`HTTP ${r.status}`);
  }
  const data = await r.json();
  const items = data.items || data.data || [];
  const source = data.source || 'unknown';

  if (items.length < 5) {
    return { status: 'fail', detail: `æ–°é—»æ•°é‡ä¸è¶³: ${items.length} < 5æ¡` };
  }
  if (source === 'local') {
    return { status: 'warn', detail: `ä½¿ç”¨æœ¬åœ°æ•°æ® (${items.length}æ¡),å¤–éƒ¨APIå¯èƒ½ä¸å¯ç”¨` };
  }

  return { status: 'pass', detail: `è·å– ${items.length} æ¡æ–°é—» (æ¥æº: ${source})` };
}

async function testFundamentals() {
  // âœ… ä¿®å¤: å»æ‰ /api å‰ç¼€ï¼Œç›´æ¥ç”¨ /fundamentals
  const r = await fetch(`${BASE_URL}/fundamentals/AAPL`);
  if (!r.ok) {
    if (r.status === 429) {
      return { status: 'warn', detail: 'APIé™æµ,å¤–éƒ¨æ•°æ®æºä¸å¯ç”¨' };
    }
    if (r.status === 404) {
      throw new Error('åŸºæœ¬é¢APIç«¯ç‚¹ä¸å­˜åœ¨,è¯·æ£€æŸ¥è·¯ç”±é…ç½®');
    }
    throw new Error(`HTTP ${r.status}`);
  }
  const data = await r.json();

  // âœ… æ£€æŸ¥å­—æ®µåï¼špe, pb, roe (å°å†™)
  const hasData = data.pe !== undefined || data.pb !== undefined || data.roe !== undefined;

  if (!hasData) {
    return { status: 'fail', detail: 'åŸºæœ¬é¢æ•°æ®ä¸ºç©º' };
  }

  return { status: 'pass', detail: `åŸºæœ¬é¢æ•°æ®æ­£å¸¸: PE=${data.pe}, PB=${data.pb}, ROE=${data.roe}` };
}

async function testPriceData() {
  const r = await fetch(`${BASE_URL}/api/prices/daily?symbol=AAPL&limit=100`);
  if (!r.ok) throw new Error(`HTTP ${r.status}: ä»·æ ¼APIä¸å¯ç”¨`);
  const data = await r.json();
  const count = data.items?.length || 0;

  if (count < 30) {
    return { status: 'fail', detail: `æ•°æ®é‡ä¸è¶³: ${count} < 30æ¡,æ— æ³•è¿›è¡Œæœ‰æ•ˆåˆ†æ` };
  }

  const latest = data.items[0]?.date;
  let daysDiff = 0;
  if (latest) {
    daysDiff = Math.floor((Date.now() - new Date(latest).getTime()) / 86400000);
    if (daysDiff > 5) {
      return { status: 'fail', detail: `æ•°æ®è¿‡æœŸ: æœ€æ–°æ•°æ®æ˜¯ ${daysDiff} å¤©å‰ (${latest})` };
    }
  }

  if (count < 100) {
    return { status: 'warn', detail: `æ•°æ®é‡: ${count}æ¡ (æœ€æ–°: ${latest}, ${daysDiff}å¤©å‰)` };
  }

  return { status: 'pass', detail: `è·å– ${count} æ¡ä»·æ ¼æ•°æ®,æœ€æ–°: ${latest} (${daysDiff}å¤©å‰)` };
}

async function testScoreBatch() {
  const r = await fetch(`${BASE_URL}/api/scores/batch`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ symbols: ['AAPL', 'MSFT', 'GOOGL'] })
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const data = await r.json();
  const items = data.items || (Array.isArray(data) ? data : []);

  if (items.length < 3) {
    return { status: 'fail', detail: `è¿”å›æ•°æ®ä¸å®Œæ•´: ${items.length}/3` };
  }

  const invalidScores = items.filter(item => {
    const scoreValue = item.score?.score;  // âœ… åµŒå¥—å–å€¼
    return scoreValue === undefined || scoreValue < 0 || scoreValue > 100;
  });

  if (invalidScores.length > 0) {
    return { status: 'fail', detail: `è¯„åˆ†å¼‚å¸¸: ${invalidScores.length} ä¸ªè‚¡ç¥¨è¯„åˆ†ä¸åœ¨0-100èŒƒå›´` };
  }

  return {
    status: 'pass',
    detail: `æ‰¹é‡è¯„åˆ†æˆåŠŸ: ${items.map(i => `${i.symbol}=${(i.score?.score || 0).toFixed(1)}`).join(', ')}`
  };
}

async function testPortfolio() {
  const r = await fetch(`${BASE_URL}/api/portfolio/propose`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      symbols: ['AAPL', 'MSFT', 'GOOGL', 'NVDA', 'AMZN'],
      params: { 'risk.max_stock': 0.30, 'risk.max_sector': 0.50 }
    })
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const data = await r.json();

  const holdings = data.holdings || [];  // âœ… åªæ£€æŸ¥ holdings

  if (holdings.length < 3) {
    return { status: 'fail', detail: `æŒä»“æ•°é‡è¿‡å°‘: ${holdings.length} < 3,æ— æ³•æœ‰æ•ˆåˆ†æ•£é£é™©` };
  }

  const totalWeight = holdings.reduce((sum, h) => sum + (h.weight || 0), 0);
  if (Math.abs(totalWeight - 1.0) > 0.01) {
    return { status: 'fail', detail: `æƒé‡å’Œå¼‚å¸¸: ${totalWeight.toFixed(3)} â‰  1.0` };
  }

  const maxWeight = Math.max(...holdings.map(h => h.weight || 0));
  if (maxWeight > 0.31) {  // âœ… æ”¾å®½åˆ°0.31
    return { status: 'fail', detail: `å•ç¥¨æƒé‡è¶…é™: ${(maxWeight*100).toFixed(1)}% > 30%` };
  }

  return { status: 'pass', detail: `ç»„åˆç”ŸæˆæˆåŠŸ: ${holdings.length} åªè‚¡ç¥¨,æœ€å¤§æƒé‡ ${(maxWeight*100).toFixed(1)}%` };
}

async function testBacktest() {
  const start = Date.now();
  const r = await fetch(`${BASE_URL}/api/backtest/run`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      weights: [{ symbol: 'AAPL', weight: 0.5 }, { symbol: 'MSFT', weight: 0.5 }],
      window_days: 120
    })
  });
  const elapsed = Date.now() - start;

  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const data = await r.json();

  if (!data.metrics && data.ann_return === undefined) {
    return { status: 'fail', detail: 'å›æµ‹è¿”å›æ•°æ®ä¸å®Œæ•´,ç¼ºå°‘metrics' };
  }

  if (elapsed > 20000) {
    return { status: 'warn', detail: `å›æµ‹è€—æ—¶è¿‡é•¿: ${(elapsed/1000).toFixed(1)}ç§’ > 20ç§’` };
  }

  const annReturn = data.ann_return || data.metrics?.ann_return;
  return { status: 'pass', detail: `å›æµ‹å®Œæˆ (${(elapsed/1000).toFixed(1)}ç§’),å¹´åŒ–æ”¶ç›Š: ${annReturn}` };
}

async function testDataFreshness() {
  const r = await fetch(`${BASE_URL}/api/scores/batch`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ symbols: ['AAPL'] })
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const data = await r.json();
  const asOf = data.as_of || data.version_tag || data.date;

  if (!asOf) {
    return { status: 'warn', detail: 'æ— æ³•è·å–æ•°æ®æ—¶é—´æˆ³' };
  }

  const daysDiff = Math.floor((Date.now() - new Date(asOf).getTime()) / 86400000);

  if (daysDiff > 2) {
    return { status: 'fail', detail: `æ•°æ®è¿‡æœŸ: ${daysDiff} å¤©å‰ (${asOf}),å¿…é¡»æ›´æ–°æ•°æ®` };
  }
  if (daysDiff > 1) {
    return { status: 'warn', detail: `æ•°æ®ç•¥æ—§: ${daysDiff} å¤©å‰ (${asOf})` };
  }

  return { status: 'pass', detail: `æ•°æ®æ–°é²œ: ${daysDiff === 0 ? 'ä»Šå¤©' : 'æ˜¨å¤©'} (${asOf})` };
}

async function testDataCompleteness() {
  const watchlist = ['AAPL', 'MSFT', 'NVDA', 'GOOGL', 'AMZN'];
  let missing = [];

  for (const symbol of watchlist) {
    try {
      const r = await fetch(`${BASE_URL}/api/prices/daily?symbol=${symbol}&limit=1`);
      if (!r.ok || !(await r.json()).items?.length) {
        missing.push(symbol);
      }
    } catch (e) {
      missing.push(symbol);
    }
  }

  if (missing.length > 2) {
    return { status: 'fail', detail: `${missing.length} åªè‚¡ç¥¨æ•°æ®ç¼ºå¤±: ${missing.join(', ')}` };
  }
  if (missing.length > 0) {
    return { status: 'warn', detail: `${missing.length} åªè‚¡ç¥¨æ•°æ®ç¼ºå¤±: ${missing.join(', ')}` };
  }

  return { status: 'pass', detail: `æ‰€æœ‰ ${watchlist.length} åªwatchlistè‚¡ç¥¨æ•°æ®å®Œæ•´` };
}

async function testSentimentAccuracy() {
  const r = await fetch(`${BASE_URL}/api/news/fetch?symbol=AAPL&days=7&source=auto`, { method: 'POST' });
  if (!r.ok) {
    if (r.status === 429) {
      return { status: 'warn', detail: 'APIé™æµ,æ— æ³•æµ‹è¯•æƒ…ç»ªå‡†ç¡®æ€§' };
    }
    throw new Error(`HTTP ${r.status}`);
  }
  const data = await r.json();
  const items = data.items || data.data || [];

  if (items.length === 0) {
    return { status: 'fail', detail: 'æ— æ–°é—»æ•°æ®,æ— æ³•è¿›è¡Œæƒ…ç»ªåˆ†æ' };
  }

  const withSentiment = items.filter(item => item.score !== undefined);  // æ”¹è¿™é‡Œ

  const invalidSentiment = withSentiment.filter(item =>
    item.score < -1 || item.score > 1  // æ”¹è¿™é‡Œ
  );

  if (invalidSentiment.length > 0) {
    return { status: 'fail', detail: `${invalidSentiment.length} æ¡æ–°é—»æƒ…ç»ªåˆ†æ•°å¼‚å¸¸ (è¶…å‡º-1~1èŒƒå›´)` };
  }
  if (withSentiment.length < items.length * 0.8) {
    return { status: 'warn', detail: `ä»… ${withSentiment.length}/${items.length} æ¡æ–°é—»æœ‰æƒ…ç»ªåˆ†æ•°` };
  }

  return { status: 'pass', detail: `æƒ…ç»ªåˆ†ææ­£å¸¸: ${withSentiment.length}/${items.length} æ¡æ–°é—»` };
}

async function testAPILatency() {
  const endpoints = [
    { name: 'health', url: '/health', max: 1000 },
    { name: 'prices', url: '/api/prices/daily?symbol=AAPL&limit=10', max: 2000 },
    { name: 'scores', url: '/api/scores/batch', method: 'POST', body: { symbols: ['AAPL'] }, max: 5000 }
  ];

  let slow = [];

  for (const ep of endpoints) {
    const start = Date.now();
    try {
      const options = ep.method === 'POST'
        ? { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ep.body) }
        : {};
      const r = await fetch(`${BASE_URL}${ep.url}`, options);
      const elapsed = Date.now() - start;

      if (elapsed > ep.max) {
        slow.push(`${ep.name}(${elapsed}ms > ${ep.max}ms)`);
      }
    } catch (e) {
      slow.push(`${ep.name}(error)`);
    }
  }

  if (slow.length > 0) {
    return { status: 'warn', detail: `å“åº”è¾ƒæ…¢çš„ç«¯ç‚¹: ${slow.join(', ')}` };
  }

  return { status: 'pass', detail: 'æ‰€æœ‰APIå“åº”æ—¶é—´æ­£å¸¸' };
}

async function testAPIConcurrent() {
  const promises = [];
  for (let i = 0; i < 5; i++) {
    promises.push(fetch(`${BASE_URL}/health`));
  }

  const start = Date.now();
  const results = await Promise.all(promises);
  const elapsed = Date.now() - start;

  const failed = results.filter(r => !r.ok).length;

  if (failed > 0) {
    return { status: 'fail', detail: `å¹¶å‘è¯·æ±‚å¤±è´¥: ${failed}/5` };
  }
  if (elapsed > 3000) {
    return { status: 'warn', detail: `å¹¶å‘å“åº”è¾ƒæ…¢: ${elapsed}ms` };
  }

  return { status: 'pass', detail: `å¹¶å‘æµ‹è¯•é€šè¿‡: 5ä¸ªè¯·æ±‚ ${elapsed}ms` };
}

window.onload = init;
</script>
</body>
</html>